name: CI-OIDC Build and Push with Auto Manifest Update

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_ACCOUNT_ID: 759348358497
  IMAGE_NAME: ghcr.io/wuyang026/cicd-study-service
  AWS_REGION: ap-south-1  # AWS のリージョン
  ROLE_TO_ASSUME: arn:aws:iam::759348358497:role/go-github-action-role  # 作成済みの OIDC ロール

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read       # リポジトリ内容の読み取り権限
      packages: write      # パッケージ書き込み権限
      id-token: write      # OIDC トークン取得権限（必須）

    steps:
      # リポジトリをチェックアウト
      - name: Checkout app repository
        uses: actions/checkout@v3
        with:
          submodules: false  # submodule を自動初期化

      # JDK 21 のセットアップ
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # Gradle Wrapper に実行権限を付与
      - name: Grant execute permission to Gradle Wrapper
        run: chmod +x ./gradlew

      # JAR をビルド
      - name: Build JAR
        run: ./gradlew :app:api:bootJar

      # コミット SHA をタグとして環境変数に設定
      - name: Set version tag (commit SHA)
        run: echo "TAG=${{ github.sha }}" >> $GITHUB_ENV

      # AWS CLI を OIDC で設定
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # Amazon ECR にログイン
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # Docker イメージのビルド
      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.TAG }} -f Dockerfile .

      # Docker イメージのタグ付け
      - name: Tag Docker image
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.TAG }} \
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}:${{ env.TAG }}

      # Docker イメージを Amazon ECR にプッシュ
      - name: Push Docker image to Amazon ECR
        run: |
          docker push \
          ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}:${{ env.TAG }}

      # manifest リポジトリの deployment.yaml を更新
      - name: Update deployment.yaml in manifest repo
        run: |
          git clone https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/wuyang026/cicd-study-manifest.git
          cd cicd-study-manifest/apps/cicd-study-service

          # イメージタグを更新
          sed -i 's|\(image: .*/.*:\).*|\1${{ env.TAG }}|' deployment.yaml
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git commit -am "Update image to ${{ env.TAG }}"
          git push
